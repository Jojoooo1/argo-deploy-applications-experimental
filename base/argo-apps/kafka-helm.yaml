apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kafka
  namespace: argocd

  # Add this finalizer ONLY if you want these to cascade delete (A cascade delete, deletes both the app and its resources, rather than only the app.)
  finalizers:
    - resources-finalizer.argocd.argoproj.io

spec:
  project: default
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground

  sources:
    - chart: kafka
      repoURL: registry-1.docker.io/bitnamicharts
      targetRevision: 25.1.10

      # https://docs.confluent.io/platform/current/kafka/deployment.html
      # https://github.com/bitnami/charts/tree/main/bitnami/kafka
      helm:
        valuesObject:
          kraft:
            enabled: true
            clusterId: GTxB5josEfsini5mBw33W7
          listeners:
            client:
              containerPort: 9092
              protocol: SASL_PLAINTEXT # SASL_SSL
            controller:
              containerPort: 9093
              protocol: SASL_PLAINTEXT
            interbroker:
              containerPort: 9094
              protocol: SASL_PLAINTEXT
          
          # https://github.com/bitnami/charts/issues/17497#issuecomment-1625089275
          # SCRAM support in KRaft mode has been recently added in the latest version 3.5 and we are currently working on adding support for it.
          sasl:
            interBrokerMechanism: PLAIN # SCRAM-SHA-256
            controllerMechanism: PLAIN # SCRAM-SHA-256
            interbroker:
              user: inter_broker_user
              # password: ""
            controller:
              user: controller_user
              # password: ""
            client:
              users:
                - admin
                - user
              # passwords: 
              #   - password
              #   - password
            existingSecret: kafka-passwords-secret

          tls:
            type: PEM
            pemChainIncluded: false
            autoGenerated: false
            existingSecret: kafka-tls-secret
            sslClientAuth: required

          extraDeploy:
            - apiVersion: v1
              kind: Secret
              metadata:
                name: kafka-passwords-secret
                namespace: kafka
                # client-passwords is used for sasl
                # system-user-password  is used for kafka exporter
              data:
                client-passwords: cGFzc3dvcmQscGFzc3dvcmQ=
                system-user-password: cGFzc3dvcmQ=
                inter-broker-password: ZDk1dTVOcGtCeA==
                controller-password: WUgxTEJkakRmeA==
              type: Opaque

            - apiVersion: v1
              kind: Secret
              metadata:
                name: kafka-tls-secret
                namespace: kafka
              data:
                kafka-ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFVENDQWZtZ0F3SUJBZ0lRWmRHaUt5K05lZFZKTzN2UkNFSVBsekFOQmdrcWhraUc5dzBCQVFzRkFEQVQKTVJFd0R3WURWUVFERXdocllXWnJZUzFqWVRBZUZ3MHlNekE1TVRVeE9UVXhNelZhRncweU5EQTVNVFF4T1RVeApNelZhTUJNeEVUQVBCZ05WQkFNVENHdGhabXRoTFdOaE1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBCk1JSUJDZ0tDQVFFQThCVUVQRWIvaFdJWXBJdnJvejdoWm5ncVJhNHVxK05CeHJQaFE3QktFa3JOWXA5MzcwWU0KQlVjTGdXd2VzOS93NHI5clk5ME9WNFEra3RxN1Y0eUIzcCtIQ1BqRnkvcnQ4Q2NEb2tCd1MwdVRsUElwc3JxTwpvaEZLeGlkREpaMmIra2JDQldpMjZRVWVFaXQrVXAxamdwM0RmSzdGR256aWY1ZnZXNUhsbitadHdwaTZSbXJXCkkrcThrQStkQm8rcUJzS052VDA2QjExeitzeHo4T2ZTc3J4N20vWFZnaStCVnRUVUdYWWhrZWJMdjl4dU5nSGEKWDE0QTQ0SHJFMjVaZXdzeHlMaUtoSnEvSWhwYU9oeHh2TGEvMzdzVjBOU0xtS0RHaEVrR0ZPQ0Z4SEErb01DRQoyQWJZaGhFajN3REQ3Ti9IamtZNzZpQnF0VDZSNG4wUHZ3SURBUUFCbzJFd1h6QU9CZ05WSFE4QkFmOEVCQU1DCkFxUXdIUVlEVlIwbEJCWXdGQVlJS3dZQkJRVUhBd0VHQ0NzR0FRVUZCd01DTUE4R0ExVWRFd0VCL3dRRk1BTUIKQWY4d0hRWURWUjBPQkJZRUZGaVFVUmY3TDJwTjFNLzNVL1g0Tm1NMHpmVVpNQTBHQ1NxR1NJYjNEUUVCQ3dVQQpBNElCQVFDM0hVMVJZc0MxN3RXRWJ6cHo0eEtRdVl2M2dNMGtNbnlKL1ZMTzMvWGl5Y0J3dm9LTUtEOWtGZnlDCkZzMTRKRlJORGFsL0RiY2VZOVZ5aUszK1ZLMmh5VmRUdzFDK21ObzZtZWNzbUc2eGdtM1VSS1p0Z0NTbjg3QVIKZk5PbExzTjRlT2VJNnNUZXc4UyszL2RHRXEvOVFzSFBwcG5Mdm1uWUZzTUJJeUgyVng0UVM1NWdoMnBmM2FKdAozNGdZbGJZVE1vSFhNTGN0aU5OSW5rZ2FrcW5PQnVER2xCTDJXRmIyNWxnVTUxS21TdDdSYTJyZ2dPMzdNY3pYCktMQnRVbVZ3VHhlZklvalNMajNJTmpxaFBkZHUvTlM4WGs2Qmg3NzBySEF6ZzRoRnViTWRUZXU4TWFyaVc1WTEKaVR6bWdwSWExdndqZGRTdldtaUppdVZBc1p2egotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
                kafka.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZUVENDQkRXZ0F3SUJBZ0lRZGNnOGNhdWJDTlFwRWxPMnc2RDBIakFOQmdrcWhraUc5dzBCQVFzRkFEQVQKTVJFd0R3WURWUVFERXdocllXWnJZUzFqWVRBZUZ3MHlNekE1TVRVeE9UVXhNelZhRncweU5EQTVNVFF4T1RVeApNelZhTUJBeERqQU1CZ05WQkFNVEJXdGhabXRoTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCCkNnS0NBUUVBeDl5REpZRmdyQXVuK3o4aFRMZXBkbGpjb0xXZGZ6a29oYzIrOHdZSUJSUHpRUWZLTjlXNFF2V3UKU1V3d1ZRWTVvWm9manVCSlpOblNpOVB1ajVDWnVQQjQ2b1hUUzhEU3VYTS9rTk5zWU1tMFV1dm1ibENOUlJCRgo4NW0vN05ldXRMTU5lZFppS25lNEE2WW9xbWw1QnVPRDhPczBUWVNTVjB3bUJZaG5nd1VZTGF3Z2ViY3ozRmUvCk1BelVyUkc3bGd4cU93M3pjdzVuUHFvc3N1eVVKY3k2YUhPczV3NEhVTDA5Z3cyTHRBcEhaaXRnWi8rV09IMUEKRTAyNlFiSjEySzNUcUpob3c0c3Rlc0o1Y2ladDhrY29jODk3U1RYVEVLS3QxTm9mbzZVN0FBSzNqQ0lhaDJBLworU0ZqUU5QQlNjdWxEdFlWMWVFeTJsQVpoNlZnandJREFRQUJvNElDbmpDQ0Fwb3dEZ1lEVlIwUEFRSC9CQVFECkFnV2dNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUZCd01CQmdnckJnRUZCUWNEQWpBTUJnTlZIUk1CQWY4RUFqQUEKTUI4R0ExVWRJd1FZTUJhQUZGaVFVUmY3TDJwTjFNLzNVL1g0Tm1NMHpmVVpNSUlDT0FZRFZSMFJCSUlDTHpDQwpBaXVDSFd0aFptdGhMbXRoWm10aExuTjJZeTVqYkhWemRHVnlMbXh2WTJGc2dndHJZV1pyWVM1cllXWnJZWUlGCmEyRm1hMkdDUkd0aFptdGhMV052Ym5SeWIyeHNaWEl0TUM1cllXWnJZUzFqYjI1MGNtOXNiR1Z5TFdobFlXUnMKWlhOekxtdGhabXRoTG5OMll5NWpiSFZ6ZEdWeUxteHZZMkZzZ2pKcllXWnJZUzFqYjI1MGNtOXNiR1Z5TFRBdQphMkZtYTJFdFkyOXVkSEp2Ykd4bGNpMW9aV0ZrYkdWemN5NXJZV1pyWVlJc2EyRm1hMkV0WTI5dWRISnZiR3hsCmNpMHdMbXRoWm10aExXTnZiblJ5YjJ4c1pYSXRhR1ZoWkd4bGMzT0NSR3RoWm10aExXTnZiblJ5YjJ4c1pYSXQKTVM1cllXWnJZUzFqYjI1MGNtOXNiR1Z5TFdobFlXUnNaWE56TG10aFptdGhMbk4yWXk1amJIVnpkR1Z5TG14dgpZMkZzZ2pKcllXWnJZUzFqYjI1MGNtOXNiR1Z5TFRFdWEyRm1hMkV0WTI5dWRISnZiR3hsY2kxb1pXRmtiR1Z6CmN5NXJZV1pyWVlJc2EyRm1hMkV0WTI5dWRISnZiR3hsY2kweExtdGhabXRoTFdOdmJuUnliMnhzWlhJdGFHVmgKWkd4bGMzT0NSR3RoWm10aExXTnZiblJ5YjJ4c1pYSXRNaTVyWVdacllTMWpiMjUwY205c2JHVnlMV2hsWVdScwpaWE56TG10aFptdGhMbk4yWXk1amJIVnpkR1Z5TG14dlkyRnNnakpyWVdacllTMWpiMjUwY205c2JHVnlMVEl1CmEyRm1hMkV0WTI5dWRISnZiR3hsY2kxb1pXRmtiR1Z6Y3k1cllXWnJZWUlzYTJGbWEyRXRZMjl1ZEhKdmJHeGwKY2kweUxtdGhabXRoTFdOdmJuUnliMnhzWlhJdGFHVmhaR3hsYzNNd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQgpBTTdib1dzQjlIdUZEd245SW8xWVJkUDVHbG41TDk1QzV1L0UwNmVOWk9BOWZpa1hLY2Rlb3lNcnBLL1NoTWMwCm5Bemx5eUtQRmJqNVJOdktaa1RZUWd2TDdzR3dxVE9FcXBxUjFJUjZHbEJvR0ZsQiswd0NVNkNPeEpvRVhBb3gKb1ZJcFJjRSt6SUlabm9JTlBVL3pEcGthRTlvMldQNWFuQkx3OHUxOXdPKzNaUGw1VTRyQXRSUnF5TGdhV25EOApVVVJlL2NPeGV1M2JuUDdtVUg3b05sb1NoT1RTalAxQVlWb2lJUitmUUEyeUQvU2dwVHNyTFgwMHdMRm8xSEZQCjRQa3E0Q2xOeU4rdU1kYVc4cDB4TTdhNkhiVW0vUWdJMWJjZ2daYnQ0MzBqMTZqU2pLenJBYUp4ZnhmMWZBTngKODZiVHNqZjl1Rld2OUdTWXhRR1lueTA9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
                kafka.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBeDl5REpZRmdyQXVuK3o4aFRMZXBkbGpjb0xXZGZ6a29oYzIrOHdZSUJSUHpRUWZLCk45VzRRdld1U1V3d1ZRWTVvWm9manVCSlpOblNpOVB1ajVDWnVQQjQ2b1hUUzhEU3VYTS9rTk5zWU1tMFV1dm0KYmxDTlJSQkY4NW0vN05ldXRMTU5lZFppS25lNEE2WW9xbWw1QnVPRDhPczBUWVNTVjB3bUJZaG5nd1VZTGF3ZwplYmN6M0ZlL01BelVyUkc3bGd4cU93M3pjdzVuUHFvc3N1eVVKY3k2YUhPczV3NEhVTDA5Z3cyTHRBcEhaaXRnClovK1dPSDFBRTAyNlFiSjEySzNUcUpob3c0c3Rlc0o1Y2ladDhrY29jODk3U1RYVEVLS3QxTm9mbzZVN0FBSzMKakNJYWgyQS8rU0ZqUU5QQlNjdWxEdFlWMWVFeTJsQVpoNlZnandJREFRQUJBb0lCQVFDb3dXZzNQZlFMc1ZmbwpqSmlvZDVmdVp2Lzc3djRLazQvRTAwSTlYOFZiekVta2lsaFVKdkNNRVhoVlNiQ3h5aXpWYUJibmhEaFVvSnZvCkYwNGpDTnpUekxDOGpiMHBCS3FwamtlSkdRdzArWHQ2WE5mWUk4bjFHOVdFNkRpbldrS1pMMnJjaW9tZkJERnIKVzF5UTc3Z1NlZjlKYU1Ca0IrR3RObzRRTStuN05NNVZzSUpWMXQ0Q0VDNWJoSHpOWVF1ZnNFaitkOW4xNnFKcgpnVDB0QysyUGdkc2ZsNkROcUVZRFpFR1JpdXlVVkltS1RmNVZ4dTRsSFZGYWtsb0dsL3d0WHM5Q2VmYlQwQWZuCnFLSGl2K2pvYTVBLzJPc3FFNlJEdW9WejkzR1l3YzVvZ00waFE2U2ZDSitQUnZwZjkrSEVOdjdTbFJlcXJuS3gKUHc0d054MWhBb0dCQU5VSGhpbmJPdHl5c0lNTTM4bUVvTkwxcElqNk4xNnZoNTVVQnNzcDY0TXI3dDRhRU1naApsckxXNUVRYnNKTUZ0MXNwR0RJQzN3eHVERGZ5L0Ewc291U28zRkN5VXBDMFIvMk1qcnllamJlZlAwVVVweStRCkFFZkx1SHhpVGZYZStyTU14ekFEK1IyYWFhT1EwQWJJUG5vNGVTeHVoOFRJQmEzMXQ1Tm9HS3BmQW9HQkFQQXQKQTZqejdSRmFpc1NaQ2RGM0d3dmlVeTNhNHdGT0EzOFJZU3djU2JvckEzSU40QWFmNHh6YUl0S0xiQSsrK2twQQp3QksreTZYWk5mbmtWa3l1aVBEd0wySXN2L3FYTWRsN2JIRnE4R0FxR3ZNYnJ2cHc4SWRmU2k1cmJ0STV5U2ZkCi9pQ29wWFlHODhJcjd5WUxSaXFMOUYxb1Y5ck0zanpTbzFlejVGZlJBb0dBRURYWlhMZ0UrNlJSVURlYms5OFcKeWRiTlpXcjg2YVNid2syTWtzc20wNzExR011TStWMnM5UURyTDgrWG1TaDNNbVduSks4WlAvM2p5aUlnVWZSUwpsT25Ra2dkdnh2a2cvVWREMlZDTFlpeXBDTjJ3ZHlzVENtT1RMMHZmdU5UMTZNZ1JKRE01TXFwOFhXajRtM3VEClhaT01qUGdBTnRZdHNIWWhPUU5UMVNzQ2dZRUFuSHNIbG0yT3VLN0FHTVVJODVOaGFNWEZvZXVwMlRERjhHVVgKWlpEc3JFSFlGZGhhYkphQmQwdmNRa2NhV2N2NDhLWHRQb2xXejdDTWpVcXF1MzAvdFpNWG5DUkIxSGZydjZHOQpqc3U0M3o2dm5sTWNGd204Zk1hbDQwYVZ4cHhscGZicDJzZG1QbGJiUEZnNWtSVHBXMUVpSGpXY2YrN1lvTkl3CklEVVJnZkVDZ1lCMUJHZjFOVDlzOGh1bVFlVVMrbHhJdUQyU21OMzBYemY2R2RZUmRsVU1QRDRLazlvZTdSMU0KWExyT1RGeWIxN1BWYzRBaDZzQzhHRlVxM05oTjJ5amo5QTgxYVpiZHRoU0lzRDdZY2xiU2VLdjBNYWppbEVwYQo4aDVEUEFreWN6WXU5NnllY2Y1MGFJc1hzektxdE9tQUQyamxNN0JyTTlTYXRmY2dmc2Z3QlE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
              type: Opaque


          controller:
            replicaCount: 3
            # resources:
            #   requests:
            #     memory: "2.5Gi"
            #     cpu: "1"
            #   limits:
            #     memory: "2.5Gi"
            #     cpu: "1"
          persistence:
            # storageClass: auto-resize
            size: 8Gi
          metrics:
            kafka:
              enabled: true
              certificatesSecret: kafka-tls-secret
              tlsCaCert: kafka-ca.crt
              tlsCert: kafka.crt
              tlsKey: kafka.key
              resources:
                requests:
                  memory: "150Mi"
                  cpu: "0.1"
                limits:
                  memory: "150Mi"
                  cpu: "0.1"
            serviceMonitor:
              enabled: true
              labels:
                prometheus.io/scrap-with: kube-prometheus-stack

    - chart: console
      repoURL: https://helm.conduktor.io
      targetRevision: 1.2.4
      # https://github.com/conduktor/conduktor-public-charts/tree/main/charts/console
      helm:
        values: |
          fullnameOverride: conduktor-console
          config:
            organization:
              name: my-org
            admin:
              email: admin@conduktor.io
              password: password
            database:
              host: conduktor-postgres
              name: conduktor
              username: admin
              password: password
          ingress:
            enabled: true
            ingressClassName: nginx
            hostname: kafka.local.com.br

    - chart: postgresql
      repoURL: registry-1.docker.io/bitnamicharts
      targetRevision: 12.8.3
      # https://github.com/bitnami/charts/tree/main/bitnami/postgresql
      helm:
        values: |
          fullnameOverride: conduktor-postgres
          auth:
            postgresPassword: password
            database: conduktor
            username: admin
            password: password

  ignoreDifferences:
    - kind: Secret
      name: kafka-tls-passwords 
      namespace: kafka
      jsonPointers:
        - /data/keystore-password
        - /data/truststore-password

  destination:
    server: "https://kubernetes.default.svc"
    namespace: kafka
